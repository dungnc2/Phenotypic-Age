<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phenotypic Age Calculator</title>
  <meta property="og:image" content="thumb.webp" />

  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container mt-5 mb-5 row justify-content-center">
    <div class="card shadow-sm p-4 col-lg-7">
      <h1 class="text-center mb-4">Phenotypic Age Calculator</h1>
      <form id="biological-age-form" class="row g-3">
        <div class="col-md-6">
          <label for="dob" class="form-label">DATE OF BIRTH</label>
          <input type="date" id="dob" name="dob" value="1954-09-27" class="form-control" required />
        </div>

        <div class="col-md-6">
          <label for="blood-test-date" class="form-label">DATE OF BLOOD TEST</label>
          <input type="date" id="blood-test-date" name="blood-test-date" class="form-control" required />
        </div>

        <h2 class="mt-4 mb-3">BLOOD TEST RESULTS</h2>

        <!-- Albumin -->
        <div class="col-md-6">
          <label for="albumin" class="form-label"> Albumin </label>
          <small id="hs_albumin">(-0.0336)</small>
          <div class="input-group">
            <input type="text" min="2" max="7" id="albumin" name="albumin" value="4.6" step="0.1"
              class="form-control number-input" />
            <span class="input-group-text">g/dL</span>
          </div>
          <i id="albumin_danger" class="text-danger view-danger d-none"></i>
        </div>

        <!-- Creatinine -->
        <div class="col-md-6">
          <label for="creatinine" class="form-label">Creatinine</label>
          <small id="hs_creatinine">(0.0095)</small>
          <div class="input-group">
            <input type="text" min="0.2" max="2" id="creatinine" name="creatinine" value="1.13" step="0.1"
              class="form-control number-input" />
            <span class="input-group-text">mg/dL</span>
          </div>
          <i id="creatinine_danger" class="text-danger view-danger d-none"></i>
        </div>

        <!-- Glucose -->
        <div class="col-md-6">
          <label for="glucose" class="form-label">Glucose</label>
          <small id="hs_glucose">(0.0190)</small>
          <div class="input-group">
            <input type="text" min="40" max="300" id="glucose" name="glucose" value="105" step="1"
              class="form-control number-input" />
            <span class="input-group-text">mg/dL</span>
          </div>
          <i id="glucose_danger" class="text-danger view-danger d-none"></i>
        </div>

        <!-- C-reactive Protein -->
        <div class="col-md-6">
          <label for="crp" class="form-label">C-reactive Protein (CRP)</label>
          <small id="hs_crp">(0.0954)</small>
          <div class="input-group">
            <input type="text" min="0" max="50" id="crp" name="crp" value="0.15" step="0.1"
              class="form-control number-input" />
            <span class="input-group-text">mg/L</span>
          </div>
          <i id="crp_danger" class="text-danger view-danger d-none"></i>
        </div>

        <!-- Lymphocyte -->
        <div class="col-md-6">
          <label for="lymphs" class="form-label">Lymphocyte (Lymphs)</label>
          <small id="hs_lymphs">(-0.0126)</small>
          <div class="input-group">
            <input type="text" min="0" max="100" id="lymphs" name="lymphs" value="24" step="0.1"
              class="form-control number-input" />
            <span class="input-group-text">%</span>
          </div>
          <i id="lymphs_danger" class="text-danger view-danger d-none"></i>
        </div>

        <!-- MCV -->
        <div class="col-md-6">
          <label for="mcv" class="form-label">Mean Cell Volume (MCV)</label>
          <small id="hs_mcv">(0.0260)</small>
          <div class="input-group">
            <input type="text" min="70" max="120" id="mcv" name="mcv" value="94.2" step="1"
              class="form-control number-input" />
            <span class="input-group-text">fL</span>
          </div>
          <i id="mcv_danger" class="text-danger view-danger d-none"></i>
        </div>

        <!-- RDW -->
        <div class="col-md-6">
          <label for="rdw" class="form-label">Red Cell Distribution Width (RDW)</label>
          <small id="hs_rdw">(0.3306)</small>
          <div class="input-group">
            <input type="text" min="10" max="20" id="rdw" name="rdw" value="15.2" step="0.1"
              class="form-control number-input" />
            <span class="input-group-text">%</span>
          </div>
          <i id="rdw_danger" class="text-danger view-danger d-none"></i>
        </div>

        <!-- Alkaline Phosphatase -->
        <div class="col-md-6">
          <label for="alkaline" class="form-label">Alkaline Phosphatase</label>
          <small id="hs_alkaline">(0.00188)</small>
          <div class="input-group">
            <input type="text" min="0" max="200" id="alkaline" name="alkaline" value="24" step="1"
              class="form-control number-input" />
            <span class="input-group-text">U/L</span>
          </div>
          <i id="alkaline_danger" class="text-danger view-danger d-none"></i>
        </div>

        <!-- White Blood Cells -->
        <div class="col-md-6">
          <label for="wbc" class="form-label">White Blood Cells</label>
          <small id="hs_wbc">(0.0554)</small>
          <div class="input-group">
            <input type="text" min="2" max="20" id="wbc" name="wbc" value="6.9" step="1"
              class="form-control number-input" />
            <span class="input-group-text">cells/mL</span>
          </div>
          <i id="wbc_danger" class="text-danger view-danger d-none"></i>
        </div>

        <!-- Select Formula -->
        <div class="col-md-6">
          <label for="wbc" class="form-label">Select Formula</label>
          <div class="input-group">
            <select class="form-control" name="formula" id="formula">
              <option value="1">Sheet</option>
              <option value="0">Papper</option>
            </select>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="col-md-12 d-grid">
          <button type="submit" class="btn btn-success btn-lg">
            Calculate Results
          </button>
        </div>
      </form><!-- Display results here -->
      <div id="result" class="mt-4 row" style="display: none">
        <div class="col-md-6">
          <h2>TEST RESULTS</h2>
          <p>
            <strong>Phenotypic Age:</strong> <span id="phenotypic-age"></span>
          </p>
          <p>
            <strong>Chronological Age:</strong>
            <span id="chronological-age"></span>
          </p>
          <p>
            <strong>Difference:</strong> <span id="age-difference"></span>
          </p>
        </div>
        <div class="col-md-6">
          <img src="thumb.webp" alt="Age Progression" class="img-fluid" />
        </div>
      </div>
    </div>
  </div>


  <!-- Bootstrap JS and Popper.js -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js"></script>
  <!-- jQuery CDN -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Custom Script -->
  <script>
    document.getElementById('blood-test-date').valueAsDate = new Date();
    let hs_gpt = {
      'alpha': 19.5,
      'albumin': -0.0336,
      'creatinine': 0.0095,
      'glucose': 0.0190,
      'crp': 0.0954,
      'lymphs': -0.0126,
      'mcv': 0.0260,
      'rdw': 0.3306,
      'alkaline': 0.00188,
      'whiteBloodCells': 0.0554,
    };
    let hs_papper = {
      'alpha': -19.9067,
      'albumin': -0.0336,
      'creatinine': 0.0095,
      'glucose': 0.1953,
      'crp': 0.0954,
      'lymphs': -0.012,
      'mcv': 0.0268,
      'rdw': 0.3306,
      'alkaline': 0.0019,
      'whiteBloodCells': 0.0554,
      'chronologicalAge': 0.0804,
    };
    let hs_cv = {
      'albumin': 10,
      'creatinine': 88.4,
      'glucose': 0.05555,
      'crp': 0.1,
    };

    $(document).ready(function () {
      $(`.number-input`).on('focusout', function () {
        validate(this.id)
      })
      $(`.number-input`).on('focusin', function () {
        $(`#${this.id}_danger`).addClass('d-none')
      })
      $(`.number-input`).on('keyup', function () {
        $(this).val(formatNumber($(this).val()));
      })
      $("#biological-age-form").submit(function (e) {
        e.preventDefault();
        // Tính toán giả định - Bạn cần thay thế phần này bằng code backend thực sự
        let phenotypicAge = 0; // Ví dụ giá trị Phenotypic Age
        let chronologicalAge = 0; // Ví dụ giá trị Chronological Age

        chronologicalAge = calculateChronologicalAge();
        let formula = parseInt($("#formula").val());

        switch (formula) {
          case 0:
            phenotypicAge = calculatePhenotypicAgePapper(chronologicalAge);
            break;
          case 1:
            phenotypicAge = calculatePhenotypicAgeSheet(chronologicalAge);
            break;
          default:
            break;
        }

        let difference = phenotypicAge - chronologicalAge; // Tính Difference

        // Hiển thị kết quả
        $("#phenotypic-age").text(phenotypicAge.toFixed(2));
        $("#chronological-age").text(chronologicalAge.toFixed(2));
        $("#age-difference").text(difference.toFixed(2));

        // Hiển thị div chứa kết quả
        let checkValidate = true;
        $('.view-danger').each((index, item) => {
          if (!$(item).hasClass('d-none')) {
            checkValidate = false
          }
        });
        if (checkValidate) {
          $("#result").show();
          scrollToBottom();
        } else {
          $("#result").hide();
        }
      });
    });

    function scrollToTop() {
      window.scrollTo(0, 0);
    }

    function scrollToBottom() {
      window.scrollTo(0, document.body.scrollHeight);
    }

    function convert_hs(hs_string) {
      let hsString = hs_string;
      hsString = hsString.replace("(", "");
      hsString = hsString.replace(")", "");

      hsString = parseFloat(hsString);

      return hsString;
    }

    function calculateChronologicalAge() {
      let birthDate = $("#dob").val();
      let testDate = $("#blood-test-date").val();
      const today = new Date(testDate); // Lấy ngày hiện tại
      const birth = new Date(birthDate); // Chuyển đổi birthDate sang kiểu Date

      // Tính tuổi theo năm, tháng, và ngày
      let years = today.getFullYear() - birth.getFullYear();
      let months = today.getMonth() - birth.getMonth();
      let days = today.getDate() - birth.getDate();

      // Điều chỉnh nếu tháng hoặc ngày là âm
      if (days < 0) {
        months -= 1;
        days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); // Lấy số ngày của tháng trước
      }
      if (months < 0) {
        years -= 1;
        months += 12;
      }

      // Chuyển tháng và ngày thành dạng thập phân
      const age = years + (months / 12) + (days / 365.25);

      // Làm tròn kết quả với 2 chữ số thập phân
      return parseFloat(age);
    }

    function calculatePhenotypicAgeGPT() {

      // Lấy giá trị của các input
      let albumin = toOriginal($("#albumin").val()); // Lấy giá trị Albumin
      let creatinine = toOriginal($("#creatinine").val()); // Lấy giá trị Creatinine
      let glucose = toOriginal($("#glucose").val()); // Lấy giá trị Glucose
      let crp = toOriginal($("#crp").val()); // Lấy giá trị C-reactive Protein (CRP)
      let lymphs = toOriginal($("#lymphs").val()); // Lấy giá trị Lymphocyte (Lymphs)
      let mcv = toOriginal($("#mcv").val()); // Lấy giá trị Mean Cell Volume (MCV)
      let rdw = toOriginal($("#rdw").val()); // Lấy giá trị Red Cell Distribution Width (RDW)
      let alkaline = toOriginal($("#alkaline").val()); // Lấy giá trị Alkaline Phosphatase
      let whiteBloodCells = toOriginal($("#wbc").val()); // Lấy giá trị White Blood Cells

      // Công thức tính tuổi sinh học
      return hs_gpt.alpha +
        hs_gpt.albumin * albumin +
        hs_gpt.creatinine * creatinine +
        hs_gpt.glucose * glucose +
        hs_gpt.crp * crp +
        hs_gpt.lymphs * lymphs +
        hs_gpt.mcv * mcv +
        hs_gpt.rdw * rdw +
        hs_gpt.alkaline * alkaline +
        hs_gpt.whiteBloodCells * whiteBloodCells;
    }

    function calculatePhenotypicAgeSheet(chronologicalAge) {

      // Lấy giá trị của các input
      let albumin = toOriginal($("#albumin").val()); // Lấy giá trị Albumin
      let creatinine = toOriginal($("#creatinine").val()); // Lấy giá trị Creatinine
      let glucose = toOriginal($("#glucose").val()); // Lấy giá trị Glucose
      let crp = toOriginal($("#crp").val()); // Lấy giá trị C-reactive Protein (CRP)
      let lymphs = toOriginal($("#lymphs").val()); // Lấy giá trị Lymphocyte (Lymphs)
      let mcv = toOriginal($("#mcv").val()); // Lấy giá trị Mean Cell Volume (MCV)
      let rdw = toOriginal($("#rdw").val()); // Lấy giá trị Red Cell Distribution Width (RDW)
      let alkaline = toOriginal($("#alkaline").val()); // Lấy giá trị Alkaline Phosphatase
      let whiteBloodCells = toOriginal($("#wbc").val()); // Lấy giá trị White Blood Cells

      let xb = hs_papper.alpha +
        hs_papper.albumin * albumin * hs_cv.albumin +
        hs_papper.creatinine * creatinine * hs_cv.creatinine +
        hs_papper.glucose * glucose * hs_cv.glucose +
        hs_papper.crp * ln(crp * hs_cv.crp) +
        hs_papper.lymphs * lymphs +
        hs_papper.mcv * mcv +
        hs_papper.rdw * rdw +
        hs_papper.alkaline * alkaline +
        hs_papper.whiteBloodCells * whiteBloodCells +
        hs_papper.chronologicalAge * chronologicalAge;

      let MortScore = 1 - exp(-exp(xb) * (exp(0.0076927 * 120) - 1) / 0.0076927);
      let PtypicAge = 141.50225 + (ln(-0.00553 * ln(1 - MortScore))) / 0.09165;
      let tuoiSinhHoc = PtypicAge / (1 + 1.28047 * exp(0.0344329 * (-182.344 + PtypicAge)));

      console.log(hs_papper.alpha,
        hs_papper.albumin * albumin * hs_cv.albumin,
        hs_papper.creatinine * creatinine * hs_cv.creatinine,
        hs_papper.glucose * glucose * hs_cv.glucose,
        hs_papper.crp * ln(crp * hs_cv.crp),
        hs_papper.lymphs * lymphs,
        hs_papper.mcv * mcv,
        hs_papper.rdw * rdw,
        hs_papper.alkaline * alkaline,
        hs_papper.whiteBloodCells * whiteBloodCells,
        hs_papper.chronologicalAge * chronologicalAge);
      return tuoiSinhHoc;
    }

    function calculatePhenotypicAgePapper(chronologicalAge) {
      // Lấy giá trị của các input
      let albumin = toOriginal($("#albumin").val()); // Lấy giá trị Albumin
      let creatinine = toOriginal($("#creatinine").val()); // Lấy giá trị Creatinine
      let glucose = toOriginal($("#glucose").val()); // Lấy giá trị Glucose
      let crp = toOriginal($("#crp").val()); // Lấy giá trị C-reactive Protein (CRP)
      let lymphs = toOriginal($("#lymphs").val()); // Lấy giá trị Lymphocyte (Lymphs)
      let mcv = toOriginal($("#mcv").val()); // Lấy giá trị Mean Cell Volume (MCV)
      let rdw = toOriginal($("#rdw").val()); // Lấy giá trị Red Cell Distribution Width (RDW)
      let alkaline = toOriginal($("#alkaline").val()); // Lấy giá trị Alkaline Phosphatase
      let whiteBloodCells = toOriginal($("#wbc").val()); // Lấy giá trị White Blood Cells

      let xb = hs_papper.alpha +
        hs_papper.albumin * albumin +
        hs_papper.creatinine * creatinine +
        hs_papper.glucose * glucose +
        hs_papper.crp * crp +
        hs_papper.lymphs * lymphs +
        hs_papper.mcv * mcv +
        hs_papper.rdw * rdw +
        hs_papper.alkaline * alkaline +
        hs_papper.whiteBloodCells * whiteBloodCells +
        hs_papper.chronologicalAge * chronologicalAge;

      // Tính exp_term
      let exp_term = (-1.51714 * Math.exp(xb)) / 0.0076927;
      // Tính tuổi sinh học theo công thức
      let tuoiSinhHoc = 141.50 + (Math.log(-0.00553 * Math.log(Math.exp(exp_term)))) / 0.09165;

      return tuoiSinhHoc;
    }
    function exp(params) {
      return Math.exp(params);
    }
    function ln(params) {
      return Math.log(params);
    }

    function validate(id) {
      let min = parseFloat($(`#${id}`).attr('min'));
      let max = parseFloat($(`#${id}`).attr('max'));
      let value = parseFloat(toOriginal($(`#${id}`).val()));
      if (value != '' || value > 0) {
        if (value >= min && value <= max) {
          $(`#${id}_danger`).addClass('d-none')
        } else {
          $(`#${id}_danger`).html('Chỉ được nhập vào giá trị trong khoảng ' + min + '-' + max);
          $(`#${id}_danger`).removeClass('d-none')
        }
      }
    }

    function toOriginal(formattedNumber) {
      return formattedNumber.replace(/[^\d.-]/g, '');
    }

    function formatNumber(number) {
      number = toOriginal(number)
      var parts = number.split(".");
      var integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      var decimalPart = parts[1];
      if (isNaN(integerPart.replace(/[^\d.]/g, ''))) {
        return '';
      } else {
        switch (decimalPart) {
          case undefined:
            return integerPart;
            break;
          case '':
            return integerPart + ".";
            break;
          default:
            return integerPart + '.' + decimalPart;
            break;
        }
      }
    }
  </script>
</body>

</html>